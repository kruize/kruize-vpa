# Kruize - VPA

Kruize VPA Recommender for Kubernetes/ Openshift

#### Acknowledgments: 

This project is inspired from [CLEVER](https://github.com/sustainable-computing-io/clever) (Container Level Energy-efficient VPA Recommender) for Kubernetes.

## Prerequisites
- Kubernetes 1.22+ or OpenShift 4.11
- Kubernetes Vertical Pod Autoscaler or OpenShift Vertical Pod Autoscaler Operator
- Kruize Running in Local Monitoring Mode

## Installation

#### Install VPA
  - Follow the instructions [here](https://github.com/kubernetes/autoscaler/blob/master/vertical-pod-autoscaler/README.md) to install the VPA on the Kubernetes Cluster. 

#### Install Kruize in Local Monitoring Mode
  - Follow the instructions [here](https://github.com/kruize/kruize-demos/tree/main/monitoring/local_monitoring) to install Kruize in local monitoring mode and sample tfb workloads.

#### Install Kruize VPA Recommender 
  - In this step, we use the kruize-vpa to deploy it as a customized recommender to run with the default VPA controllers. Clone the Kruize VPA repository. 
    ```commandline
    git clone https://github.com/kruize/kruize-vpa.git
    cd kruize-vpa
    ```
  - Update the Kruize URL in the manifest file at line#65 `kruize_url: ""`:
    - For OpenShift, retrieve the routes:
    ```commandline
    oc get routes -n openshift-tuning
    ```
    - For Minikube, use the format [minikube_ip]:PORT. 
    - _Note_: This URL is also logged in the kruize-demo script.

  - Apply the manifest
    ```commandline
    kubectl apply -f manifests/kruize-vpa.yaml
    ```
    
### Updating Recommendations with Kruize VPA Recommender:
Deploy the example application that selects the Kruize recommender for VPA.
```commandline
kubectl apply -f examples/sysbench.yaml
```
The example YAML also defines a VPA Custom Resource with the following configuration to auto update 

```commandline
apiVersion: "autoscaling.k8s.io/v1"
kind: VerticalPodAutoscaler
metadata:
  name: sysbench-vpa
spec:
  recommenders:
    - name: kruize
  targetRef:
    apiVersion: "apps/v1"
    kind: Deployment
    name: sysbench
  resourcePolicy:
    containerPolicies:
      - containerName: '*'
        controlledResources: ["cpu", "memory"]
```

Kruize VPA will monitor all deployments that have the VPA custom resource defined. It generates and applies recommendations based on the specified resource policies. 

You can also check the logs for the recommendations generated by Kruize VPA to understand the adjustments being made:

```commandline
$ oc logs -n kube-system kruize-vpa-5497f6f7cb-wh78s
Kruize URL: http://kruize-openshift-tuning.apps.vpatest.lab.psi.pnq2.redhat.com
VerticalPodAutoscaler CRD is present!
VPA sysbench-vpa has chosen kruize recommender.
Selected VPA sysbench-vpa in namespace default and deployment sysbench.
Generating recommendations - 
http://kruize-openshift-tuning.apps.vpatest.lab.psi.pnq2.redhat.com/listExperiments?experiment_name=sysbench-vpa
Experiment for VPA exists.
http://kruize-openshift-tuning.apps.vpatest.lab.psi.pnq2.redhat.com/generateRecommendations?experiment_name=sysbench-vpa
Fetched latest recommendations.
Selected containers to update - 
[{'container_image_name': 'quay.io/rh-ee-shesaxen/sysbench', 'container_name': 'sysbench'}]
CPU Recommendations: 0.3428931864151752
Memory Recommendations: 3307929.6
[{'containerName': 'sysbench', 'lowerBound': {'cpu': '342m', 'memory': '3Mi'}, 'target': {'cpu': '342m', 'memory': '3Mi'}, 'upperBound': {'cpu': '342m', 'memory': '3Mi'}}]
Patching vpa object with available recommendations.
VPA has been patched to apply recommendations.
Sleeping for 60 seconds ...

******************************************************************
```
